(function(){"use strict";var e={2018:function(e,t,a){var s=a(9242),i=a(3396);function l(e,t,a,s,l,n){const r=(0,i.up)("DoodlePanel");return(0,i.wg)(),(0,i.j4)(r)}const n={class:"canvasLCss"},r={class:"canvasFixCss"},o={class:"canvasPianoLCss",ref:"canvasPianoLCss"},d={class:"canvasPianoRCss"},h={class:"canvasTimeTickerTCss",ref:"canvasTimeTickerTCss"},c={class:"canvasTimeTickerBCss",ref:"canvasLFix"},u={class:"lControllerCss"},p={class:"canvasRCss"},m={class:"canvasFixCss",ref:"canvasRFix"},v={class:"rControllerCss"};function g(e,t,a,s,l,g){const b=(0,i.up)("piano-canvas"),f=(0,i.up)("time-ticker-canvas"),C=(0,i.up)("piano-roll-canvas"),D=(0,i.up)("el-affix"),k=(0,i.up)("piano-panel"),w=(0,i.up)("timbre-space-canvas"),S=(0,i.up)("timbre-panel");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i._)("div",n,[(0,i.Wm)(D,{offset:10},{default:(0,i.w5)((()=>[(0,i._)("div",r,[(0,i._)("div",o,[(0,i.Wm)(b,{ref:"piano"},null,512)],512),(0,i._)("div",d,[(0,i._)("div",h,[(0,i.Wm)(f,{ref:"timbreTicker"},null,512)],512),(0,i._)("div",c,[(0,i.Wm)(C,{ref:"testCanvas",canvasName:"timbreSpaceCVS",W:l.canvasLCssW,H:l.canvasLCssH,blockY:!0,onPianoPanelAction:g.pianoPanelAction,onTimbrePanelAction:g.timbrePanelAction,onTimbreSpaceAction:g.timbreSpaceAction},null,8,["W","H","onPianoPanelAction","onTimbrePanelAction","onTimbreSpaceAction"])],512)])])])),_:1}),(0,i._)("div",u,[(0,i.Wm)(k,{sources:l.sources,ref:"pianoPanel",onPianoRollAction:g.pianoRollAction,onTimbrePanelAction:g.timbrePanelAction,onTimbreSpaceAction:g.timbreSpaceAction,onUpdateSources:g.updateSources,onUpdateCanvas:g.updateCanvas,onRefreshCanvas:g.refreshCanvas,onChangeTrk:g.changeTrk},null,8,["sources","onPianoRollAction","onTimbrePanelAction","onTimbreSpaceAction","onUpdateSources","onUpdateCanvas","onRefreshCanvas","onChangeTrk"])])]),(0,i._)("div",p,[(0,i.Wm)(D,{offset:10},{default:(0,i.w5)((()=>[(0,i._)("div",m,[(0,i.Wm)(w,{ref:"timbrePalette",brushSize:2.4,strokeSize:.2,canvasName:"timbreSpaceCVS",W:l.canvasRCssW,H:l.canvasRCssH},null,8,["brushSize","strokeSize","W","H"])],512)])),_:1}),(0,i._)("div",v,[(0,i.Wm)(S,{sources:l.sources,ref:"timbrePanel",onPianoPanelAction:g.pianoPanelAction,onChangeTrk:g.changeTrk,onTimbreSpaceAction:g.timbreSpaceAction,onUpdateSources:g.updateSources},null,8,["sources","onPianoPanelAction","onChangeTrk","onTimbreSpaceAction","onUpdateSources"])])])],64)}var b=a(7139);const f=e=>((0,i.dD)("data-v-738b19cb"),e=e(),(0,i.Cn)(),e),C={class:"timbrePanelCss"},D=(0,i.uE)('<div class="narrowBandCss" data-v-738b19cb><span data-v-738b19cb>Timbre database: </span></div><div class="hintCss" data-v-738b19cb><div data-v-738b19cb><b data-v-738b19cb>Load</b> timbre embeddings from a database</div><div data-v-738b19cb><b data-v-738b19cb>Tag</b> sources using timbre embeddings in the database</div><div data-v-738b19cb><b data-v-738b19cb>Select</b> timbre embeddings to re-separate</div><div data-v-738b19cb><b data-v-738b19cb>Save</b> current timbre embeddings</div></div>',2),k={class:"largeBandCss"},w=(0,i.Uk)("Load"),S=(0,i.Uk)("Tag"),_=(0,i.Uk)("Select"),y={class:"largeBandCss"},A={class:"largeWCss"},B={class:"narrowCss"},W=(0,i.Uk)("Save"),T={class:"largeBandCss"},P=f((()=>(0,i._)("div",{class:"narrowWCss"},[(0,i._)("span",null,"Pitch range: ")],-1))),R={class:"midWCss"};function z(e,t,a,s,l,n){const r=(0,i.up)("el-button"),o=(0,i.up)("el-option"),d=(0,i.up)("el-select"),h=(0,i.up)("el-input"),c=(0,i.up)("el-slider");return(0,i.wg)(),(0,i.iD)("div",C,[D,(0,i._)("div",k,[(0,i.Wm)(r,{type:"primary",ref:"loadBt",size:"small",disabled:!l.analyzed,onClick:n.onClickLoad},{default:(0,i.w5)((()=>[w])),_:1},8,["disabled","onClick"]),(0,i._)("input",{type:"file",hidden:"",ref:"uploadDB",onChange:t[0]||(t[0]=(...e)=>n.onClickLoadDB&&n.onClickLoadDB(...e))},null,544),(0,i.Wm)(r,{type:"warning",ref:"hideBt",plain:"",size:"small",disabled:!l.analyzed,onClick:n.onClickCancel},{default:(0,i.w5)((()=>[(0,i.Uk)((0,b.zw)(l.hideDB),1)])),_:1},8,["disabled","onClick"]),(0,i.Wm)(r,{type:"primary",size:"small",disabled:0==l.timbreDB.length,onClick:n.onClickTag},{default:(0,i.w5)((()=>[S])),_:1},8,["disabled","onClick"]),(0,i.Wm)(r,{type:"warning",size:"small",disabled:!l.analyzed},{default:(0,i.w5)((()=>[_])),_:1},8,["disabled"])]),(0,i._)("div",y,[(0,i._)("div",A,[(0,i.Wm)(h,{disabled:!l.analyzed,modelValue:l.instr,"onUpdate:modelValue":t[2]||(t[2]=e=>l.instr=e),placeholder:"Instrument name",class:"input-with-select"},{prepend:(0,i.w5)((()=>[(0,i.Wm)(d,{modelValue:l.selectTrk,"onUpdate:modelValue":t[1]||(t[1]=e=>l.selectTrk=e),onChange:n.onSelectChangeTrk,placeholder:"Select",style:{width:"110px"},disabled:!l.analyzed},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.sources,(e=>((0,i.wg)(),(0,i.j4)(o,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange","disabled"])])),_:1},8,["disabled","modelValue"])]),(0,i._)("div",B,[(0,i.Wm)(r,{type:"danger",size:"small",disabled:!l.analyzed},{default:(0,i.w5)((()=>[W])),_:1},8,["disabled"])])]),(0,i._)("div",T,[P,(0,i._)("div",R,[(0,i.Wm)(c,{modelValue:l.pitchRange,"onUpdate:modelValue":t[3]||(t[3]=e=>l.pitchRange=e),range:"",max:l.pitchMax,min:l.pitchMin,size:"small",disabled:"",class:"slider",onChange:n.onChangePitchRange},null,8,["modelValue","max","min","onChange"])])])])}var x={name:"TimbrePanel",components:{},props:{sources:Object},data(){return{analyzed:!1,instr:"undefined",pitchRange:[1,128],pitchMin:1,pitchMax:128,hideDB:"hide",timbreDB:[],selectTrk:1}},methods:{callFunc(e){let t=e.func,a=e.arg;this.$options.methods[t](this,a)},setPitchRange(e,t){e.pitchMin=t[0],e.pitchMax=t[1],e.pitchRange=t},setAnalyzed(e,t){e.analyzed=t.analyzed},pianoPanelAction(e,t=null){let a={func:e,arg:t};this.$emit("pianoPanelAction",a)},timbreSpaceAction(e,t=null){let a={func:e,arg:t};this.$emit("timbreSpaceAction",a)},onChangePitchRange(e){},onSelectChangeTrk(e){this.$emit("changeTrk",this.selectTrk)},onClickLoad(){this.$refs.uploadDB.click()},onClickLoadDB(e){let t=e.target.files[0],a=new FileReader,s=this;a.onload=e=>{let t=JSON.parse(e.target.result);s.timbreDB=t,s.timbreSpaceAction("loadTimbreDB",this.timbreDB)},a.readAsText(t),console.log("here")},onClickCancel(e){"hide"==this.hideDB?(this.timbreSpaceAction("loadTimbreDB",[]),this.hideDB="show"):(this.timbreSpaceAction("loadTimbreDB",this.timbreDB),this.hideDB="hide")},onClickTag(e){this.timbreSpaceAction("tagTrks",this.timbreDB),this.$emit("updateSources",null)}}},$=a(89);const U=(0,$.Z)(x,[["render",z],["__scopeId","data-v-738b19cb"]]);var V=U;const F=e=>((0,i.dD)("data-v-17be0f7b"),e=e(),(0,i.Cn)(),e),H={class:"pianoPanel"},M={class:"basicPanel"},L=F((()=>(0,i._)("div",{class:"xlargeWCss"}," Mouse Settings: ",-1))),N=F((()=>(0,i._)("div",{class:"xlargeWCss"},"   - Click ",-1))),j={class:"xlargeWCss"},O={class:"xlargeWCss"},E=(0,i.Uk)("Drag"),Z={class:"xlargeWCss"},I=(0,i.Uk)("Crop"),Y={class:"xlargeWCss"},J=(0,i.Uk)("Fill"),G=F((()=>(0,i._)("div",{class:"xlargeWCss"},"   - Scroll ",-1))),X={class:"xlargeWCss"},K=(0,i.Uk)("zoom"),Q={class:"cropPanel"},q={class:"cropPanel"},ee={class:"xlargeWCss"},te=F((()=>(0,i._)("div",{class:"padWCss"},[(0,i._)("span",null,"Target source:")],-1))),ae={class:"largeWCss"},se={class:"xlargeWCss"},ie=F((()=>(0,i._)("div",{class:"padWCss"},[(0,i._)("span",null,"Start - End time (s):")],-1))),le={class:"mlargeWCss"},ne={class:"timeCss"},re=F((()=>(0,i._)("div",{class:"narWCss"},"-",-1))),oe={class:"timeCss"},de={class:"xlargeWCss"},he=(0,i.Uk)("Crop"),ce=(0,i.Uk)("Revise"),ue=(0,i.Uk)("Erase"),pe=(0,i.Uk)("Fill"),me={class:"xlargeWCss"},ve=(0,i.Uk)("Undo"),ge=(0,i.Uk)("Redo"),be=(0,i.Uk)("Reset"),fe=(0,i.Uk)("Refine");function Ce(e,t,a,s,l,n){const r=(0,i.up)("el-radio"),o=(0,i.up)("el-radio-group"),d=(0,i.up)("el-checkbox"),h=(0,i.up)("audio-panel"),c=(0,i.up)("transfer-data-dialog"),u=(0,i.up)("el-option"),p=(0,i.up)("el-select"),m=(0,i.up)("el-input"),v=(0,i.up)("el-button"),g=(0,i.up)("save-change-dialog");return(0,i.wg)(),(0,i.iD)("div",H,[(0,i._)("div",M,[L,N,(0,i._)("div",j,[(0,i.Wm)(o,{modelValue:l.mode,"onUpdate:modelValue":t[0]||(t[0]=e=>l.mode=e),onChange:n.onChangeMode},{default:(0,i.w5)((()=>[(0,i._)("div",O,[(0,i.Wm)(r,{label:1},{default:(0,i.w5)((()=>[E])),_:1})]),(0,i._)("div",Z,[(0,i.Wm)(r,{label:2},{default:(0,i.w5)((()=>[I])),_:1})]),(0,i._)("div",Y,[(0,i.Wm)(r,{label:3},{default:(0,i.w5)((()=>[J])),_:1})])])),_:1},8,["modelValue","onChange"])]),G,(0,i._)("div",X,[(0,i.Wm)(d,{modelValue:l.enableZoom,"onUpdate:modelValue":t[1]||(t[1]=e=>l.enableZoom=e),onChange:n.onChangeZoom},{default:(0,i.w5)((()=>[K])),_:1},8,["modelValue","onChange"])])]),(0,i._)("div",Q,[(0,i.Wm)(h,{ref:"audioPanel",onSetAnalyze:n.setAnalyze,onSetAudioData:n.setAudioData,onUpdatePlayingBar:n.updatePlayingBar},null,8,["onSetAnalyze","onSetAudioData","onUpdatePlayingBar"])]),(0,i._)("div",q,[(0,i.Wm)(c,{ref:"transferDataDialog",sources:a.sources,onSetAnalyzed:n.setAnalyzed,onSetRepData:n.setRepData,onSetSepData:n.setSepData},null,8,["sources","onSetAnalyzed","onSetRepData","onSetSepData"]),(0,i._)("div",ee,[te,(0,i._)("div",ae,[(0,i.Wm)(p,{modelValue:l.selectTrk,"onUpdate:modelValue":t[2]||(t[2]=e=>l.selectTrk=e),placeholder:"Select source",size:"small",disabled:!l.analyzed,onChange:n.onSelectChangeTrk},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.sources,(e=>((0,i.wg)(),(0,i.j4)(u,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled","onChange"])])]),(0,i._)("div",se,[ie,(0,i._)("div",le,[(0,i._)("div",ne,[(0,i.Wm)(m,{modelValue:l.minSec,"onUpdate:modelValue":t[3]||(t[3]=e=>l.minSec=e),disabled:"",placeholder:"00:00"},null,8,["modelValue"])]),re,(0,i._)("div",oe,[(0,i.Wm)(m,{modelValue:l.maxSec,"onUpdate:modelValue":t[4]||(t[4]=e=>l.maxSec=e),disabled:"",placeholder:"00:00"},null,8,["modelValue"])])])]),(0,i._)("div",de,[(0,i.Wm)(v,{type:"warning",size:"small",onClick:n.onClickCrop,disabled:!l.isCrop},{default:(0,i.w5)((()=>[he])),_:1},8,["onClick","disabled"]),(0,i.Wm)(v,{type:"primary",plain:"",size:"small",onClick:n.onClickRevise,disabled:!l.isCrop},{default:(0,i.w5)((()=>[ce])),_:1},8,["onClick","disabled"]),(0,i.Wm)(v,{type:"warning",size:"small",onClick:n.onClickErase,disabled:!l.isCrop},{default:(0,i.w5)((()=>[ue])),_:1},8,["onClick","disabled"]),(0,i.Wm)(v,{type:"primary",plain:"",size:"small",onClick:n.onClickFill,disabled:!l.isPaint},{default:(0,i.w5)((()=>[pe])),_:1},8,["onClick","disabled"])]),(0,i._)("div",me,[(0,i.Wm)(v,{type:"warning",plain:"",size:"small",onClick:n.onClickUndo,disabled:!l.isCrop},{default:(0,i.w5)((()=>[ve])),_:1},8,["onClick","disabled"]),(0,i.Wm)(v,{type:"primary",size:"small",onClick:n.onClickRedo,disabled:!l.isCrop},{default:(0,i.w5)((()=>[ge])),_:1},8,["onClick","disabled"]),(0,i.Wm)(v,{type:"warning",plain:"",size:"small",onClick:n.onClickReset,disabled:!l.isCrop},{default:(0,i.w5)((()=>[be])),_:1},8,["onClick","disabled"]),(0,i.Wm)(v,{type:"danger",size:"small",disabled:!l.isCrop,onClick:n.onClickRefine},{default:(0,i.w5)((()=>[fe])),_:1},8,["disabled","onClick"]),(0,i.Wm)(g,{ref:"saveChangeDialog",onSetAnalyzed:n.setAnalyzed,onSetSepData:n.setSepData},null,8,["onSetAnalyzed","onSetSepData"])])])])}const De=e=>((0,i.dD)("data-v-90c23d8a"),e=e(),(0,i.Cn)(),e),ke={class:"xlargeWCss"},we=De((()=>(0,i._)("div",{class:"largePadWCss"},[(0,i._)("span",null,"Upload a mixture:"),(0,i._)("div",{class:"narWCss"}," mp3/wav file with a duration less than 2 min ")],-1))),Se=(0,i.Uk)("Select"),_e={class:"audioPlayer"},ye={class:"xlargeWCss"},Ae=De((()=>(0,i._)("div",{class:"narCss"},[(0,i._)("span",null,"Audio play mode:")],-1))),Be={class:"largeWCss"},We=(0,i.Uk)("Mixture"),Te=(0,i.Uk)("Target sources"),Pe={class:"xlargeWCss"},Re=["src"];function ze(e,t,a,s,l,n){const r=(0,i.up)("el-button"),o=(0,i.up)("el-upload"),d=(0,i.up)("el-radio"),h=(0,i.up)("el-radio-group");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i._)("div",ke,[we,(0,i.Wm)(o,{ref:"uploadRef",action:"",limit:1,"on-exceed":n.handleExceed,"on-change":n.onChangeFile,"auto-upload":!1},{default:(0,i.w5)((()=>[(0,i.Wm)(r,{type:"primary",size:"small"},{default:(0,i.w5)((()=>[Se])),_:1})])),_:1},8,["on-exceed","on-change"])]),(0,i._)("div",_e,[(0,i._)("div",ye,[Ae,(0,i._)("div",Be,[(0,i.Wm)(h,{modelValue:l.mode,"onUpdate:modelValue":t[0]||(t[0]=e=>l.mode=e),onChange:n.onChangeMode},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{label:1},{default:(0,i.w5)((()=>[We])),_:1}),(0,i.Wm)(d,{label:2,disabled:!l.analyzed},{default:(0,i.w5)((()=>[Te])),_:1},8,["disabled"])])),_:1},8,["modelValue","onChange"])])]),(0,i._)("div",Pe,[(0,i._)("audio",{id:"myAudio",controls:"",src:l.audioSrc,onTimeupdate:t[1]||(t[1]=(...e)=>n.updateTime&&n.updateTime(...e))},null,40,Re)])])],64)}var xe={name:"AudioPanel",data(){let e=0,t=0;return{sepURL:{},mode:1,selectTrk:1,enableAudioSubmit:!1,analyzed:!1,audioSrc:"mix.wav",hasRawInput:!1,hasSeparate:!1,minDur:e,maxDur:t,currentDur:e,totalDur:t,processStr:this.getFormatProcess(e,t)}},watch:{currentCur(){this.processStr=this.getFormatProcess()}},mounted(){this.audio=document.getElementById("myAudio")},methods:{padNum(e,t){return(Array(t).join("0")+e).slice(-t)},formatTime(e){let t=Math.floor(e/60);return e-=60*t,this.padNum(t,2)+" : "+this.padNum(e,2)},getFormatProcess(e,t){return null==e&&(e=this.currentDur,t=this.totalDur),this.formatTime(e)+" - "+this.formatTime(t)},updateTime(e){this.currentDur=e.target.currentTime,this.$emit("updatePlayingBar",this.currentDur)},onChangeFile(e){e=e.raw;let t="audio/mp3"===e.type||"audio/wav"===e.type,a=e.size/1024/1024<20;if(t||this.$message.error("Please select a file with wav/mp3 format Ｏ(ゝω・´★)"),a||this.$message.error("Refuse! it's tooooo large Ｏ(ゝω・´★)"),t&&a){let t=this,a=new FileReader;a.readAsDataURL(e),this.audioData={data:e,type:e.type},this.$emit("setAudioData",this.audioData),a.onloadend=function(e){t.mixtureURL=e.target.result,t.audioSrc=e.target.result,t.setAnalyze()}}else this.$refs.uploadRef.clearFiles()},onClickUpload(e){this.$refs.uploadRef.submit()},onClickPlay(){this.$refs.audio.play()},onChangeMode(){let e=1==this.mode?this.mixtureURL:this.sepURL[""+(this.selectTrk-1)];this.changeAudioSrc(e)},changeAudioSrc(e){let t=this.audio,a=t.currentTime;t.pause(),this.audioSrc=e,t.onloadedmetadata=function(){t.currentTime=a,t.play()}},setSepData(e){console.log(e.pos,e.data),this.sepURL[e.pos+""]=e.data},setSelectTrk(e){if(this.selectTrk=e,2==this.mode){let e=this.sepURL[""+(this.selectTrk-1)];this.changeAudioSrc(e)}},setAnalyze(){this.hasRawInput=!0,this.analyzed=!1,this.mode=1,this.audio.currentTime=0,this.$emit("setAnalyze",null)},handleExceed(e){this.$refs.uploadRef.clearFiles(),this.$refs.uploadRef.handleStart(e[0])},setAnalyzed(e){e||(this.mode=1),this.analyzed=e}}};const $e=(0,$.Z)(xe,[["render",ze],["__scopeId","data-v-90c23d8a"]]);var Ue=$e;const Ve=e=>((0,i.dD)("data-v-166eb34a"),e=e(),(0,i.Cn)(),e),Fe={class:"xlargeWCss"},He=Ve((()=>(0,i._)("div",{class:"padWCss"},[(0,i._)("span",null,"Select sources num:")],-1))),Me={class:"nnarWCss"},Le={class:"narWCss"},Ne=(0,i.Uk)("Analyze"),je={class:"xlargeWCss"},Oe=(0,i.Uk)("Download"),Ee=(0,i.Uk)(" the data file "),Ze=(0,i.Uk)(" Open this "),Ie=Ve((()=>(0,i._)("a",{href:"https://colab.research.google.com/github/anonymous-16/santouguai_v03_server/blob/main/santouguai_v03_step1.ipynb"},"link",-1))),Ye=(0,i.Uk)(" in a new window, upload the data file and run the model to get the result url. "),Je=(0,i.Uk)("Upload"),Ge=(0,i.Uk)("the result file (output_step1.zip) and click 'confirm' "),Xe={class:"dialog-footer"},Ke=(0,i.Uk)("Cancel"),Qe=(0,i.Uk)("Confirm");function qe(e,t,a,s,l,n){const r=(0,i.up)("el-option"),o=(0,i.up)("el-select"),d=(0,i.up)("el-button"),h=(0,i.up)("el-timeline-item"),c=(0,i.up)("el-upload"),u=(0,i.up)("el-timeline"),p=(0,i.up)("el-form"),m=(0,i.up)("el-dialog"),v=(0,i.Q2)("loading");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i._)("div",Fe,[He,(0,i._)("div",Me,[(0,i.Wm)(o,{modelValue:l.sourcesNum,"onUpdate:modelValue":t[0]||(t[0]=e=>l.sourcesNum=e),placeholder:"Select",size:"small",disabled:!l.hasRawInput,onChange:n.onSelectChangeSourcesNum},{default:(0,i.w5)((()=>[((0,i.wg)(),(0,i.iD)(i.HY,null,(0,i.Ko)([1,2,3,4,5,6,7,8,9,10],(e=>(0,i.Wm)(r,{key:e,label:e,value:e},null,8,["label","value"]))),64))])),_:1},8,["modelValue","disabled","onChange"])]),(0,i._)("div",Le,[(0,i.Wm)(d,{type:"warning",size:"small",onClick:t[1]||(t[1]=e=>l.dialogFormVisible=!0),disabled:l.disAnalyze},{default:(0,i.w5)((()=>[Ne])),_:1},8,["disabled"])])]),(0,i._)("div",je,[(0,i.wy)(((0,i.wg)(),(0,i.j4)(m,{modelValue:l.dialogFormVisible,"onUpdate:modelValue":t[3]||(t[3]=e=>l.dialogFormVisible=e),title:"Analyze mixture..."},{footer:(0,i.w5)((()=>[(0,i._)("span",Xe,[(0,i.Wm)(d,{onClick:t[2]||(t[2]=e=>l.dialogFormVisible=!1)},{default:(0,i.w5)((()=>[Ke])),_:1}),(0,i.Wm)(d,{type:"primary",onClick:n.onClickConfirm},{default:(0,i.w5)((()=>[Qe])),_:1},8,["onClick"])])])),default:(0,i.w5)((()=>[(0,i.Wm)(p,null,{default:(0,i.w5)((()=>[(0,i.Wm)(u,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,{timestamp:"Step 1"},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{type:"danger",onClick:n.onClickDownloadData},{default:(0,i.w5)((()=>[Oe])),_:1},8,["onClick"]),Ee])),_:1}),(0,i.Wm)(h,{timestamp:"Step 2"},{default:(0,i.w5)((()=>[Ze,Ie,Ye])),_:1}),(0,i.Wm)(h,{timestamp:"Step 3"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{ref:"uploadRef",action:"",limit:1,"on-exceed":n.handleExceed,"on-change":n.onChangeFile,"auto-upload":!1},{default:(0,i.w5)((()=>[(0,i.Wm)(d,{type:"success",size:"small"},{default:(0,i.w5)((()=>[Je])),_:1}),Ge])),_:1},8,["on-exceed","on-change"])])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])),[[v,l.loading]])])],64)}var et=a(11),tt=a(4730),at=a.n(tt),st={name:"TransferDataDialog",props:{sources:Object},data(){return{loading:!1,allSources:this.sources,disAnalyze:!0,sourcesNum:1,hasRawInput:!1,dialogFormVisible:!1,selectedFile:null,jsonData:null}},methods:{setAudioData(e){this.audioData=e},onClickDownloadData(e){let t=this.audioData,a=t.data,s=t.type;const i=new Blob([a],{type:s}),l=new(at());let n="audio/wav"==s?"input_data/mix.wav":"input_data/mix.mp3";l.file(n,i);let r={sourcesNum:this.sourcesNum,audioType:s};r=JSON.stringify(r),l.file("input_data/metadata",r),l.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then((e=>{(0,et.saveAs)(e,"input_data.zip")}))},onChangeFile(e){e=e.raw;let t="application/zip"===e.type;t?this.selectedFile=e:(this.$message.error("Please select 'output_step1.zip' Ｏ(ゝω・´★)"),this.$refs.uploadRef.clearFiles(),this.selectedFile=null)},handleExceed(e){this.$refs.uploadRef.clearFiles(),this.$refs.uploadRef.handleStart(e[0])},onClickConfirm(e){this.loading=!0;let t=this.selectedFile;if(null==t)return void this.$message.error("Please select the file 'output_step1.zip' Ｏ(ゝω・´★)");let a=new FileReader;a.readAsArrayBuffer(t);let s=this.audioData,i=s.data,l=s.type;const n=new Blob([i],{type:l});this.audioBlob=n;let r=this;a.onloadend=function(e){let t=e.target.result;at().loadAsync(t).then((e=>{let t=e.file("output_step1/data.json").async("string");r.setRepData({sourcesNum:r.sourcesNum,mix:r.audioBlob}),t.then((e=>{let t=JSON.parse(e);r.jsonData=t,r.setAnalyzed()}));for(let a=0;a<r.sourcesNum;++a){let t=e.file("output_step1/"+a+".wav").async("blob");t.then((e=>{r.setSepData(URL.createObjectURL(e),a,r.sourcesNum)}))}}))}},onSelectChangeSourcesNum(e){this.disAnalyze=!1},setSepData(e,t,a){let s={data:e,pos:t,sourcesNum:a};this.$emit("setSepData",s)},setRepData(e){this.$emit("setRepData",e)},setAnalyzed(){this.disAnalyze=!0,this.loading=!1,this.dialogFormVisible=!1,this.$emit("setAnalyzed",this.jsonData)},setAnalyze(){this.disAnalyze=!1,this.hasRawInput=!0,this.jsonData=null}}};const it=(0,$.Z)(st,[["render",qe],["__scopeId","data-v-166eb34a"]]);var lt=it;const nt=e=>((0,i.dD)("data-v-ab97b44c"),e=e(),(0,i.Cn)(),e),rt={class:"xlargeWCss"},ot=(0,i.Uk)("Download"),dt=(0,i.Uk)(" the data file "),ht=(0,i.Uk)(" Open this "),ct=nt((()=>(0,i._)("a",{href:"https://colab.research.google.com/github/anonymous-16/santouguai_v03_server/blob/main/santouguai_v03_step2.ipynb"},"link",-1))),ut=(0,i.Uk)(" in a new window, upload the data file and run the model to get the result url. "),pt=(0,i.Uk)("Upload"),mt=(0,i.Uk)("the result file (output_step2.zip) and click 'confirm' "),vt={class:"dialog-footer"},gt=(0,i.Uk)("Cancel"),bt=(0,i.Uk)("Confirm");function ft(e,t,a,s,l,n){const r=(0,i.up)("el-button"),o=(0,i.up)("el-timeline-item"),d=(0,i.up)("el-upload"),h=(0,i.up)("el-timeline"),c=(0,i.up)("el-form"),u=(0,i.up)("el-dialog"),p=(0,i.Q2)("loading");return(0,i.wg)(),(0,i.iD)("div",rt,[(0,i.Wm)(u,{modelValue:l.dialogFormVisible,"onUpdate:modelValue":t[1]||(t[1]=e=>l.dialogFormVisible=e),title:"Revise result..."},{footer:(0,i.w5)((()=>[(0,i._)("span",vt,[(0,i.Wm)(r,{onClick:t[0]||(t[0]=e=>l.dialogFormVisible=!1)},{default:(0,i.w5)((()=>[gt])),_:1}),(0,i.Wm)(r,{type:"primary",onClick:n.onClickConfirm},{default:(0,i.w5)((()=>[bt])),_:1},8,["onClick"])])])),default:(0,i.w5)((()=>[(0,i.Wm)(c,null,{default:(0,i.w5)((()=>[(0,i.Wm)(h,null,{default:(0,i.w5)((()=>[(0,i.Wm)(o,{timestamp:"Step 1"},{default:(0,i.w5)((()=>[(0,i.wy)(((0,i.wg)(),(0,i.j4)(r,{type:"danger",onClick:n.onClickDownloadData},{default:(0,i.w5)((()=>[ot])),_:1},8,["onClick"])),[[p,l.loading]]),dt])),_:1}),(0,i.Wm)(o,{timestamp:"Step 2"},{default:(0,i.w5)((()=>[ht,ct,ut])),_:1}),(0,i.Wm)(o,{timestamp:"Step 3"},{default:(0,i.w5)((()=>[(0,i.wy)(((0,i.wg)(),(0,i.j4)(d,{ref:"uploadRef",action:"",limit:1,"on-exceed":n.handleExceed,"on-change":n.onChangeFile,"auto-upload":!1},{default:(0,i.w5)((()=>[(0,i.Wm)(r,{type:"success",size:"small"},{default:(0,i.w5)((()=>[pt])),_:1}),mt])),_:1},8,["on-exceed","on-change"])),[[p,l.loading]])])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])}a(8675),a(3462);function Ct(e){return JSON.parse(JSON.stringify(e))}function Dt(e,t){let a=e[0],s=e[1],i=t[0]-a,l=t[1]-s;return i<0&&(i=-i,a=t[0]),l<0&&(l=-l,s=t[1]),[a,s,i,l]}function kt(e){let t=[];for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);return new Uint8Array(t)}function wt(e,t=0){let a=Math.floor(e/60),s=e-60*a;return s=t>0?s.toFixed(t):Math.floor(s),a=(a+"").padStart(2,"0"),s=(s+"").padStart(2,"0"),a=a.slice(-2,a.length),s=0==t?s.slice(-2,s.length):s.slice(-3-t,s.length),a+":"+s}var St={name:"SaveChangeDialog",data(){return{dialogFormVisible:!1,jsonData:null,loading:!1}},methods:{setJsonData(e){this.jsonData={data:e,sourcesNum:this.sourcesNum}},setRepData(e){this.sourcesNum=e.sourcesNum,this.audioBlob=e.mix},showDialog(){this.dialogFormVisible=!0},onClickDownloadData(e){if(null==this.jsonData||null==this.audioBlob)return void this.$message.error("ahhhhhhhhhhhhhhhhhhhhhhhh' Ｏ(ゝω・´★)");this.loading=!0;const t=new(at());let a=kt(JSON.stringify(this.jsonData)),s=new Blob([a],{type:"application/octet-stream"}),i="revised_data/data.json";t.file(i,s);let l="revised_data/mix.wav";t.file(l,this.audioBlob),t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then((e=>{(0,et.saveAs)(e,"revised_data.zip"),this.loading=!1}))},onChangeFile(e){e=e.raw;let t="application/zip"===e.type&&"output_step2.zip"===e.name;t?this.selectedFile=e:(this.$message.error("Please select 'output_step2.zip' Ｏ(ゝω・´★)"),this.$refs.transferUploadRef.clearFiles(),this.selectedFile=null)},handleExceed(e){this.$refs.uploadRef.clearFiles(),this.$refs.uploadRef.handleStart(e[0])},onClickConfirm(e){let t=this.selectedFile;if(null==t)return void this.$message.error("Please select the file 'output_step2.zip' Ｏ(ゝω・´★)");this.loading=!0;let a=new FileReader;a.readAsArrayBuffer(t);let s=this;a.onloadend=function(e){let t=e.target.result;at().loadAsync(t).then((e=>{let t=e.file("output_step2/data.json").async("string");t.then((e=>{let t=JSON.parse(e);s.setAnalyzed(t)})),s.sepURL=[];for(let a=0;a<s.sourcesNum;++a){let t=e.file("output_step2/"+a+".wav").async("blob");t.then((e=>{s.setSepData(URL.createObjectURL(e),a,s.sourcesNum)}))}}))}},setSepData(e,t,a){let s={data:e,pos:t,sourcesNum:a};this.$emit("setSepData",s)},setAnalyzed(e){this.disAnalyze=!0,this.loading=!1,this.dialogFormVisible=!1,this.$emit("setAnalyzed",e),this.jsonData=null}}};const _t=(0,$.Z)(St,[["render",ft],["__scopeId","data-v-ab97b44c"]]);var yt=_t,At={name:"PianoPanel",components:{SaveChangeDialog:yt,TransferDataDialog:lt,AudioPanel:Ue},props:{sources:Object},data(){return{mode:1,enableZoom:!0,isSelect:!1,analyzed:!1,dialogFormVisible:!1,resUrl:"",formLabelWidth:120,isDrag:!1,isCrop:!1,isPaint:!1,minSec:"00:00",maxSec:"00:00",selectTrk:1}},methods:{callFunc(e){let t=e.func,a=e.arg;this.$options.methods[t](this,a)},setAnalyze(){this.analyzed=!1,this.$emit("refreshCanvas",null),this.$refs.transferDataDialog.setAnalyze(),this.$refs.audioPanel.setAnalyzed(this.analyzed),this.reset();let e={analyzed:this.analyzed,sources:this.sources,selectTrk:this.selectTrk};this.$emit("timbrePanelAction",{func:"setAnalyzed",arg:e})},setRepData(e){this.$refs.saveChangeDialog.setRepData(e)},setSepData(e){this.$refs.audioPanel.setSepData(e)},setAnalyzed(e){this.$emit("refreshCanvas",e);let t=[];for(let s=0;s<this.$refs.transferDataDialog.sourcesNum;++s)t.push({value:s+1,label:s+1+""});this.selectTrk=1,this.analyzed=null!=e,this.$refs.audioPanel.setAnalyzed(this.analyzed);let a={analyzed:this.analyzed,sources:t,selectTrk:this.selectTrk,pca:e.pca,center:e.center};this.$emit("timbrePanelAction",{func:"setAnalyzed",arg:a}),this.$emit("updateSources",t)},pianoRollAction(e,t=null){let a={func:e,arg:t};this.$emit("pianoRollAction",a)},timbreSpaceAction(e,t=null){let a={func:e,arg:t};this.$emit("timbreSpaceAction",a)},updatePlayingBar(e){this.pianoRollAction("updatePlayingBar",e)},reset(){return!this.analyzed&&(this.isDrag=!1,this.isCrop=!1,this.isPaint=!1,!0)},onSetDrag(e){this.reset()||(this.isDrag=!0,this.isCrop=!1,this.isPaint=!1,this.pianoRollAction("setGeneral"))},onSetPaint(e){this.reset()||(this.isDrag=!1,this.isCrop=!1,this.isPaint=!0,this.pianoRollAction("setPaint"))},onSetCrop(e){this.reset()||(this.isDrag=!1,this.isCrop=!0,this.isPaint=!1,this.pianoRollAction("setCrop"))},onChangeZoom(e){this.pianoRollAction("setZoom",this.enableZoom),this.timbreSpaceAction("setZoom",this.enableZoom)},onChangeMode(e){1==this.mode?this.onSetDrag(e):2==this.mode?this.onSetCrop(e):3==this.mode&&this.onSetPaint(e)},onSelectChangeTrk(e){this.$emit("changeTrk",this.selectTrk)},updateSecRange(e,t){e.minSec=wt(t[0]),e.maxSec=wt(t[2]),e.$emit("updateCanvas",t)},onClickCrop(e){this.pianoRollAction("crop")},onClickRevise(e){this.pianoRollAction("revise")},onClickErase(e){this.pianoRollAction("erase")},onClickFill(e){this.pianoRollAction("fill")},onClickUndo(e){this.pianoRollAction("undo")},onClickRedo(e){this.pianoRollAction("redo")},onClickReset(e){this.pianoRollAction("reset")},onClickRefine(e){this.pianoRollAction("setJsonData",null),this.$refs.saveChangeDialog.showDialog()},setJsonData(e,t){e.$refs.saveChangeDialog.setJsonData(t)},setAudioData(e){this.$refs.transferDataDialog.setAudioData(e)}}};const Bt=(0,$.Z)(At,[["render",Ce],["__scopeId","data-v-17be0f7b"]]);var Wt=Bt;a(6265);const Tt={ref:"canvas"};function Pt(e,t,a,s,l,n){return(0,i.wg)(),(0,i.iD)("div",null,[(0,i._)("canvas",Tt,null,512)])}var Rt={name:"TimeTickerCanvas",mounted(){this.cvs=this.$refs.canvas,this.ctx=this.$refs.canvas.getContext("2d")},methods:{setSize(e,t){this.W=e,this.H=t,this.cvs.width=this.W,this.cvs.height=this.H},formatSec(e,t){let a=1,s=0;return t-e<=30&&t-e>10?(a=2,s=0):t-e<=10&&t-e>5?(a=10,s=0):t-e<=5&&(a=20,s=1),t*=a,e*=a,[e,t,a,s]},refresh(e,t){let a,s,i=this.ctx,l=10;i.clearRect(0,0,this.W,this.H),i.lineWidth=1,i.strokeStyle="#000000",[e,t,a,s]=this.formatSec(e,t);let n=this.W/(t-e);for(let r=0;r<=t-e;++r)i.beginPath(),i.moveTo(r*n,0),Math.floor((e+r)/l)*l==e+r?(i.lineTo(r*n,this.H),i.stroke(),i.fillText(wt(1*(e+r)/a,s),(r+.1)*n,this.H)):(i.lineTo(r*n,.4*this.H),i.stroke())}}};const zt=(0,$.Z)(Rt,[["render",Pt]]);var xt=zt;const $t={ref:"canvas"};function Ut(e,t,a,s,l,n){return(0,i.wg)(),(0,i.iD)("div",null,[(0,i._)("canvas",$t,null,512)])}var Vt={name:"PianoCanvas",mounted(){this.cvs=this.$refs.canvas,this.ctx=this.$refs.canvas.getContext("2d")},methods:{setSize(e,t,a){this.W=e,this.H=t,this.padH=a,this.cvs.width=this.W,this.cvs.height=this.H},getWhiteKeys(e){let t=Math.floor((e+9)/12);return e<=6?Math.floor((e+2)/2)+7*t:Math.floor((e+3)/2)+7*t},refresh(e,t){let a=this.ctx,s=this.H-this.padH;e=128-t,t=128-e;let i=this.getWhiteKeys(e),l=this.getWhiteKeys(t),n=l-i,r=1*s/n;this.ctx.strokeStyle="black",a.lineWidth=1;for(let o=0;o<n;++o)a.strokeRect(0,o*r+this.padH,this.W,r)}}};const Ft=(0,$.Z)(Vt,[["render",Ut]]);var Ht=Ft;class Mt{constructor(e,t){this.mean=e.mean,this.cps=e.cps,this.centerEmb=t,this.data=[],this.embeddings={data:[],tag:[]},this.centerData={data:[],tag:[]},this.initialize()}initialize(){let e=this.pcaTransform(this.centerEmb),t=[];for(let s=0;s<e.length;++s)t.push(s+1+"");let a=t;this.centerData={data:e,tag:a}}tag(){for(let e=0;e<this.centerData.data.length;++e){let t=-1,a=233333;for(let s=0;s<this.embeddings.data.length;++s){let i=0;for(let t=0;t<this.embeddings.data[s].length;++t)i+=(this.embeddings.data[s][t]-this.centerData.data[e][t])**2;i<a&&(a=i,t=s)}this.centerData.tag[e]=this.embeddings.tag[t]}}load_db(e){this.data=e;let t=[],a=[];for(let s=0;s<e.length;++s)t.push(e[s].tag),a.push(e[s].embedding);a=this.pcaTransform(a),this.embeddings={data:a,tag:t}}pcaTransform(e){let t=[];for(let a=0;a<e.length;++a){let s=[];for(let t=0;t<this.cps[0].length;++t){let i=0;for(let s=0;s<this.cps.length;++s)i+=(e[a][s]-this.mean[s])*this.cps[s][t];s.push(i)}t.push(s)}return t}getCenters(){return this.centerData}getEmbeddings(){return this.embeddings}}function Lt(e,t){let a=new Mt(e,t);return a}const Nt={style:{"background-color":"white"}},jt={ref:"canvas"};function Ot(e,t,a,s,l,n){return(0,i.wg)(),(0,i.iD)("div",Nt,[(0,i._)("canvas",jt,null,512)])}var Et=a(5449);class Zt{constructor(e,t,a,s,i,l){this.brushSize=l,this.blockX=s,this.blockY=i,this.paintedData=e.data.data,this.paintedColor=e.color,this.border=e.data.border,this.canvasW=t,this.canvasH=a,this.initialize()}initialize(){this.initColors(),this.initBorder(),this.initProps(),this.pushInStack()}initColors(){let e=["rgb(194,194,194)","rgb(255,202,202)","rgb(172,212,255)","rgb(252,243,154)","rgb(158,255,152)","rgb(210,164,252)","rgb(252,187,122)"],t=["rgb(121,121,121)","rgb(255,0,0)","rgb(0,124,255)","rgb(252,228,0)","rgb(13,243,0)","rgb(130,0,248)","rgb(255,132,0)"],a=["rgba(75,75,75,0.63)","rgba(150,0,0,0.74)","rgba(0,67,141,0.77)","rgba(148,138,0,0.7)","rgba(3,141,0,0.68)","rgba(70,0,140,0.74)","rgba(140,70,0,0.68)"];this.lightColors=t,this.darkColors=e,this.alphaColors=a}initBorder(){this.selectedTrk=1,this.dataNum=this.paintedData.length,this.viewDataBorder=Ct(this.border),this.stateDataBorder=Ct(this.border),this.clickCenter=[0,0],this.currentCenter=[this.canvasW,this.canvasH]}initProps(){this.dataStack=[],this.stackCur=0,this.xlimit=63,this.ylimit=1}updateColor(e){this.paintedColor=e}setSparseView(){this.darkColors[0]="rgba(255,255,255,0)"}setSelectedTrk(e){this.selectedTrk=e}hasNoData(){return null==this.paintedData}pos2data(e,t,a=!1){return a?(e=e/this.canvasW*(this.stateDataBorder[2]-this.stateDataBorder[0])+this.stateDataBorder[0],t=t/this.canvasH*(this.stateDataBorder[3]-this.stateDataBorder[1])+this.stateDataBorder[1]):(e=e/this.canvasW*(this.viewDataBorder[2]-this.viewDataBorder[0])+this.viewDataBorder[0],t=t/this.canvasH*(this.viewDataBorder[3]-this.viewDataBorder[1])+this.viewDataBorder[1]),[e,t]}data2pos(e,t){return e=(e-this.viewDataBorder[0])/(this.viewDataBorder[2]-this.viewDataBorder[0])*this.canvasW,t=(t-this.viewDataBorder[1])/(this.viewDataBorder[3]-this.viewDataBorder[1])*this.canvasH,[e,t]}formatData(e){let t=e[0],a=e[1];return t=t*(this.border[2]-this.border[0])/this.canvasW,a=a*(this.border[3]-this.border[1])/this.canvasH,t=Math.round(t)/(this.border[2]-this.border[0])*this.canvasW,a=Math.round(a)/(this.border[3]-this.border[1])*this.canvasH,[t,a]}formatViewBorderUnit(e,t=!0){let a=(this.border[2+e]-this.border[e])/(this.viewDataBorder[2+e]-this.viewDataBorder[e]);a<1&&(this.viewDataBorder[e]=this.border[e],this.viewDataBorder[2+e]=this.border[2+e]),this.viewDataBorder[e]<this.border[e]?(t&&(this.viewDataBorder[2+e]+=this.border[e]-this.viewDataBorder[e]),this.viewDataBorder[e]=this.border[e]):this.viewDataBorder[2+e]>this.border[2+e]&&(t&&(this.viewDataBorder[e]-=this.viewDataBorder[2+e]-this.border[2+e]),this.viewDataBorder[2+e]=this.border[2+e])}formatViewBorder(e=!0){this.formatViewBorderUnit(0,e),this.formatViewBorderUnit(1,e)}selectedData(){let e,t,a,s,i,l,n,r;return[e,t,a,s]=Dt(this.clickCenter,this.currentCenter),[i,n]=this.pos2data(e,t),[l,r]=this.pos2data(e+a,t+s),i=Math.round(i),l=Math.round(l),n=Math.round(n),r=Math.round(r),[i,n,l,r]}selectedArea(){let e,t,a,s;return[e,a,t,s]=this.selectedData(),[e,a]=this.data2pos(e,a),[t,s]=this.data2pos(t,s),[e,a,t-e,s-a]}resetSelectedArea(){this.clickCenter=[0,0],this.currentCenter=[this.canvasW,this.canvasH]}resetViewBorder(){this.viewDataBorder=Ct(this.border)}setSelectedArea(e,t){null!=e&&(this.clickCenter=e),null!=t&&(this.currentCenter=t)}paint_all_data(e,t){let a,s,i,l,n,r,o,d,h;if("all"==e?(a=0,s=0,i=this.canvasW,l=this.canvasH,e="general"):[a,s,i,l]=this.selectedArea(),0!=i&&0!=l){[r,o]=this.pos2data(a,s),[d,h]=this.pos2data(a+i,s+l),n=0;while(-1!=n)n=this.paint_data_unit(n,r,o,d,h,e,t)}}paint_data_unit(e,t,a,s,i,l,n){let r=this.paintedData,o=this.paintedColor[e],d=o-1==this.selectedTrk;o=d?this.lightColors[o-1]:this.darkColors[o-1];let h=e,c=r[e][2];if(r[e][0]>s)return c;if(r[e][1]>i)return c;if(r[e][1]<a)return c;let u=this.paintedColor,p=-1;while(c>-1&&r[h][1]==r[c][1]&&r[h][0]+1>=r[c][0])if(u[c]!=u[e])while(c>-1&&u[c]!=u[e])-1==p&&(p=c),c=r[c][2];else h=c,c=r[h][2];if(r[h][0]<t)return p>0?p:c;d&&(l="select");let m,v,g,b,f=this.brushSize>0?0:1,C=this.brushSize>0?this.brushSize:this.canvasH/(this.viewDataBorder[3]-this.viewDataBorder[1]);return"background"==l&&(o=this.darkColors[0]),[m,g]=this.data2pos(r[e][0],r[e][1]),[v,g]=this.data2pos(r[h][0]+f,r[e][1]),b=v-m,n(m,g,b,C,o,l),p>0?p:c}backupStateDataBorder(){this.stateDataBorder=Ct(this.viewDataBorder)}getYRange(e,t){return[e+t*this.border[3],e-t*this.border[1]]}getBarPos(e){let t=this.data2pos(e,0);if(this.viewDataBorder[2]<this.border[2]&&e>(this.viewDataBorder[0]+this.viewDataBorder[2])/2&&e<=this.viewDataBorder[2]){let e=this.data2pos((this.viewDataBorder[0]+this.viewDataBorder[2])/2,0);this.setSelectedArea(t,t),this.backupStateDataBorder(),this.moveView(e)}return this.data2pos(e,0)[0]}getXViewBorder(){return[Math.floor(this.viewDataBorder[0]/62.5),this.viewDataBorder[1],Math.floor(this.viewDataBorder[2]/62.5),this.viewDataBorder[3]]}getScale(){return[(this.border[2]-this.border[0])/(this.viewDataBorder[2]-this.viewDataBorder[0]),(this.border[3]-this.border[1])/(this.viewDataBorder[3]-this.viewDataBorder[1])]}moveView(e,t=1){let a=1,s=1;this.currentCenter=e,this.currentCenter[0]<this.clickCenter[0]&&(a=-1),this.currentCenter[1]<this.clickCenter[1]&&(s=-1);let[i,l,n,r]=this.selectedData(),o=n-i,d=r-l;this.viewDataBorder[0]=this.stateDataBorder[0]-o*a,this.viewDataBorder[1]=this.stateDataBorder[1]-d*s,this.viewDataBorder[2]=this.stateDataBorder[2]-o*a,this.viewDataBorder[3]=this.stateDataBorder[3]-d*s,this.formatViewBorder()}scaleView(e,t){if(1==e)return;if(e>1&&this.viewDataBorder[0]==this.border[0]&&this.viewDataBorder[1]==this.border[1]&&this.viewDataBorder[2]==this.border[2]&&this.viewDataBorder[3]==this.border[3])return;if(e<1){if(this.viewDataBorder[2]-this.viewDataBorder[0]<1)return;if(this.viewDataBorder[2]-this.viewDataBorder[0]<=this.xlimit||this.viewDataBorder[3]-this.viewDataBorder[1]<=this.ylimit)return}let a,s,i,l;i=this.viewDataBorder[2]-this.viewDataBorder[0],l=this.viewDataBorder[3]-this.viewDataBorder[1],[a,s]=this.pos2data(t[0]-t[0]*e,t[1]-t[1]*e),this.blockX||(this.viewDataBorder[0]=a,this.viewDataBorder[2]=this.viewDataBorder[0]+i*e),this.blockY||(this.viewDataBorder[1]=s,this.viewDataBorder[3]=this.viewDataBorder[1]+l*e),this.formatViewBorder(!1)}smallView(){let e,t,a,s;return[e,t,a,s]=this.selectedData(),[e+2,t+2,a-2,s-2]}pushInStack(e=!1,t=null){if(e)return void(this.dataStack[this.stackCur-1]=[Ct(this.paintedData),Ct(this.paintedColor)]);let a,s;if(null!=t){let e=Ct(this.dataStack[t]);a=e[0],s=e[1]}else a=Ct(this.paintedData),s=Ct(this.paintedColor);this.stackCur==this.dataStack.length?this.dataStack.push([a,s]):this.dataStack[this.stackCur]=[a,s],this.dataStack.length>30?this.dataStack=this.dataStack.slice(1,this.dataStack.length-1):this.stackCur++,this.stackCur!=this.dataStack.length&&(this.dataStack=this.dataStack.slice(0,this.stackCur))}replace(e=0,t=!1,a=!1){this.pushInStack(!0);let s,i,l,n,r,o,d=0,h=this.paintedData,c=this.paintedColor;[s,l,i,n]=this.selectedData();while(d>-1)[r,o]=[h[d][0],h[d][1]],r>=s&&o>=l&&r<i&&o<n?t||(c[d]=e,a&&(h[d][3]=1)):t&&(c[d]=e),d=h[d][2];this.pushInStack()}crop(e=!0,t=!0,a=1,s=!1){let i,l,n,r;[i,l,n,r]=this.selectedData(),n-i<0||r-l<0?(0,Et.z8)("Please select a larger clip."):(this.blockX&&(i=this.border[0],n=this.border[2]),this.blockY&&(l=this.border[1],r=this.border[3]),this.replace(a,t,s),e&&(this.viewDataBorder=[i,l,n,r],this.resetSelectedArea()))}filter(){this.crop(!1,!0);let e=this.paintedColor;return this.undo(),e}revise(){this.crop(!1,!1,this.selectedTrk+1,!0)}erase(){this.crop(!1,!1,1,!0)}reset(){[this.paintedData,this.paintedColor]=this.dataStack[0],this.stackCur=1,this.resetSelectedArea(),this.resetViewBorder()}undo(){this.stackCur<=1||([this.paintedData,this.paintedColor]=this.dataStack[this.stackCur-2],this.stackCur--)}redo(){this.stackCur!==this.dataStack.length&&([this.paintedData,this.paintedColor]=this.dataStack[this.stackCur],this.stackCur++)}}function It(e,t,a,s,i,l,n){let r=new Zt(e,t,a,s,i,l,n);return r}var Yt={name:"BasicCanvas",props:{sources:Object,W:Number,H:Number,strokeSize:{type:Number,default:1},brushSize:{type:Number,default:0},blockX:{type:Boolean,default:!1},blockY:{type:Boolean,default:!1}},data(){return{enableZoom:!0,isGeneral:!1,isCrop:!1,isPaint:!1,isDown:-1,selectTrk:1,unlock:!0,brushScale:1}},mounted(){this.ctx=this.$refs.canvas.getContext("2d"),this.cvs=this.$refs.canvas,this.emptyCanvas(this.W,this.H,null),this.cvs.onmousedown=this.mouseDown,this.cvs.onmouseup=this.mouseUp,this.cvs.onmousemove=this.mouseMove,this.cvs.onMouseout=this.mouseOut,this.cvs.onmousewheel=this.mouseWheel},methods:{callFunc(e){let t=e.func,a=e.arg;this.$options.methods[t](this,a)},setGeneral(e,t){e.isGeneral=!0,e.isCrop=!1,e.isPaint=!1,e.paint_all_data(1,"all")},setZoom(e,t){e.enableZoom=t},cleanSelectArea(){let e,t,a,s;[e,t,a,s]=this.canvasData.selectedArea(),0!=a&&0!=s&&this.ctx.clearRect(e,t,a,s)},getMousePos(e){let t=this.cvs,a=t.getBoundingClientRect();return[(e.clientX-a.left)*t.width/a.width,(e.clientY-a.top)*t.height/a.height]},emptyCanvas(e,t,a){let s=this.cvs;s.width=e,s.height=t,null==a?this.canvasData=null:this.refreshData(a)},refreshData(e){this.canvasData=It(e,this.cvs.width,this.cvs.height,this.blockX,this.blockY,this.brushSize),this.setGeneral(this),this.refresh()},paint(e=0,t="general"){1==e?this.ctx.clearRect(0,0,this.cvs.width,this.cvs.height):2==e&&this.cleanSelectArea(),this.canvasData.paint_all_data(t,this.fill_rect)},fill_rect(e,t,a,s,i,l){let n=this.ctx;n.fillStyle=i;let r=this.canvasData.getScale();n.fillRect(e,t,a+this.brushSize*r[0],s+this.brushSize*r[1]),"select"==l&&(n.lineWidth=this.strokeSize,n.strokeStyle="rgb(87,87,87)",n.strokeRect(e,t,a+this.brushSize*r[0],s+this.brushSize*r[1])),"activate"==l&&(n.fillStyle="rgba(0,0,0,0.8)",n.fillRect(e,t,a+this.brushSize*r[0],s+this.brushSize*r[1]))},mouseWheel(e){if(null==this.canvasData)return;let t=e.deltaY>0?"down":"up";if("up"==t&&e.deltaY<=-5){let t=this.getMousePos(e);this.canvasData.scaleView(.9,t),this.paint_all_data(1,"all"),this.mouseMoveAction()}else if("down"==t&&e.deltaY>=125){let t=this.getMousePos(e);this.canvasData.scaleView(1.1,t),this.paint_all_data(1,"all"),this.mouseMoveAction()}e.preventDefault()},mouseDown(e){if(this.isDown=e.button,null==this.canvasData||0!=this.isDown)return;this.paint_all_data(2,"highlight"),this.mouseDownAction();let t=this.getMousePos(e);this.canvasData.setSelectedArea(t,t),this.isGeneral&&this.canvasData.backupStateDataBorder(),e.preventDefault()},mouseDownAction(){},mouseOut(e){this.mouseUp(e)},mouseUp(e){this.isDown>-1&&(this.isDown=-1),e.preventDefault()},mouseMove(e){if(null==this.canvasData||0!=this.isDown)return;let t=this.getMousePos(e);if(this.isGeneral)this.canvasData.moveView(t),this.paint_all_data(1,"all"),this.mouseMoveAction();else if(this.unlock){let e,a,s,i;this.unlock=!1,this.paint_all_data(2,"highlight"),this.canvasData.setSelectedArea(null,t),this.ctx.fillStyle="rgba(0,255,196,0.22)",[e,a,s,i]=this.canvasData.selectedArea(),s>4&&i>4&&(this.ctx.fillRect(e+2,a+2,s-2,i-2),this.paint_all_data(0,"highlight"));let l=this.canvasData.filter();this.timbreSpaceAction("updateColor",l),this.unlock=!0}e.preventDefault()},selectChangeTrk(e,t){e.canvasData.setSelectedTrk(t),e.paint_all_data(1,"all")},mouseMoveAction(){}}};const Jt=(0,$.Z)(Yt,[["render",Ot]]);var Gt=Jt,Xt={extends:Gt,name:"TimbreSpaceCanvas",methods:{refresh(){this.canvasData.setSparseView()},initSpace(e,t){this.timbreDB=Lt(e,t)},paint_all_data(e=0,t="general"){this.paint(e,t),this.paintTimbreDB(),this.paintCenter()},changeTrk(e,t){e.canvasData.setSelectedTrk(t)},updateColor(e,t){e.canvasData.updateColor(t),e.paint_all_data(1,"all")},paintCenter(){let e=this.timbreDB.getCenters();for(let t=0;t<e.data.length;++t){let a,s,i;[a,s]=e.data[t],i=e.tag[t],this.drawEmbeddingCenter(a,s,i,t)}},paintTimbreDB(){let e=this.timbreDB.getEmbeddings();for(let t=0;t<e.data.length;++t){let a,s,i;[a,s]=e.data[t],i=e.tag[t],this.drawEmbeddingCenter(a,s,i,-1)}},loadTimbreDB(e,t){e.timbreDB.load_db(t),e.paint_all_data(1,"all")},drawEmbeddingCenter(e,t,a,s){let i=s>=0?4:.1,l=this.ctx;l.beginPath(),l.fillStyle=this.canvasData.alphaColors[s+1];let n=this.canvasData.data2pos(1e3*e,1e3*t);l.arc(n[0],n[1],this.brushSize*i,0,2*Math.PI),l.fill(),l.beginPath(),l.strokeStyle="black",l.arc(n[0],n[1],this.brushSize*i,0,2*Math.PI),l.stroke(),l.fillStyle="black",l.font="20px serif",l.fillText(a,n[0],n[1])},tagTrks(e,t){e.timbreDB.load_db(t),e.timbreDB.tag()}}};const Kt=Xt;var Qt=Kt,qt={extends:Gt,name:"PianoRollCanvas",mounted(){},methods:{mouseDownAction(){this.updateTimbreSpace()},mouseMoveAction(){this.updateSecRange()},refresh(){let e=this.canvasData.getYRange(129,-1);this.timbrePanelAction("setPitchRange",e),this.updateSecRange()},paint_all_data(e=0,t="general"){this.paint(e,t)},pianoPanelAction(e,t){let a={func:e,arg:t};this.$emit("pianoPanelAction",a)},timbrePanelAction(e,t){let a={func:e,arg:t};this.$emit("timbrePanelAction",a)},timbreSpaceAction(e,t){let a={func:e,arg:t};this.$emit("timbreSpaceAction",a)},updateTimbreSpace(){this.timbreSpaceAction("updateColor",this.canvasData.paintedColor)},setJsonData(e){let t={data:e.canvasData.paintedData,color:e.canvasData.paintedColor};e.pianoPanelAction("setJsonData",t)},crop(e){e.canvasData.crop(),e.paint_all_data(1,"all"),e.updateTimbreSpace(),e.updateSecRange()},reset(e){e.canvasData.reset(),e.paint_all_data(1,"all"),e.updateTimbreSpace(),e.updateSecRange()},fill(e){e.replace(e.selectTrk+1,!0),e.paint_all_data(1,"all"),e.updateTimbreSpace()},revise(e){e.canvasData.revise(),e.paint_all_data(1,"all"),e.updateTimbreSpace()},erase(e){e.canvasData.erase(),e.paint_all_data(1,"all"),e.updateTimbreSpace()},updatePlayingBar(e,t){if(null==e.canvasData)return;let a=e.canvasData.getBarPos(Math.round(62.5*t));e.paint_all_data(1,"all"),e.ctx.fillStyle="rgba(0,255,196,0.22)",e.ctx.fillRect(a,0,5,e.cvs.height),e.updateSecRange()},updateSecRange(){let e=this.canvasData.getXViewBorder();this.pianoPanelAction("updateSecRange",e)},undo(e){e.canvasData.undo(),e.paint_all_data(1,"all"),e.updateTimbreSpace()},redo(e){e.canvasData.redo(),e.paint_all_data(1,"all"),e.updateTimbreSpace()},setPaint(e,t){e.isGeneral=!1,e.isCrop=!1,e.isPaint=!0,e.paint_all_data(1,"all")},setCrop(e){e.isGeneral=!1,e.isCrop=!0,e.isPaint=!1,e.paint_all_data(1,"all")}}};const ea=qt;var ta=ea,aa={name:"DoodlePanel",components:{PianoRollCanvas:ta,TimbreSpaceCanvas:Qt,PianoCanvas:Ht,TimeTickerCanvas:xt,TimbrePanel:V,PianoPanel:Wt},data(){return{canvasLCssW:100,canvasLCssH:100,canvasRCssW:100,canvasRCssH:100,sources:[{id:1,label:"Undefined"}],selectTrk:1}},mounted(){let e=this.$refs.canvasLFix,t=this.$refs.canvasRFix;this.canvasLCssW=e.clientWidth,this.canvasLCssH=e.clientHeight,this.canvasRCssW=t.clientWidth,this.canvasRCssH=t.clientHeight,this.$refs.testCanvas.emptyCanvas(this.canvasLCssW,this.canvasLCssH,null),this.$refs.timbrePalette.emptyCanvas(this.canvasRCssW,this.canvasRCssH,null),this.$refs.timbreTicker.setSize(this.$refs.canvasTimeTickerTCss.clientWidth,this.$refs.canvasTimeTickerTCss.clientHeight),this.$refs.piano.setSize(this.$refs.canvasPianoLCss.clientWidth,this.$refs.canvasPianoLCss.clientHeight,this.$refs.canvasTimeTickerTCss.clientHeight)},methods:{refreshCanvas(e){if(null==e)this.$refs.testCanvas.emptyCanvas(this.canvasLCssW,this.canvasLCssH,null),this.$refs.timbrePalette.emptyCanvas(this.canvasRCssW,this.canvasRCssH,null);else{let t={data:e.pianoRoll,color:e.color},a={data:e.timbre,color:e.color};this.$refs.timbrePalette.initSpace(e.pca,e.center),this.$refs.testCanvas.emptyCanvas(this.canvasLCssW,this.canvasLCssH,t),this.$refs.timbrePalette.emptyCanvas(this.canvasRCssW,this.canvasRCssH,a)}},updateCanvas(e){this.$refs.timbreTicker.refresh(e[0],e[2]),this.$refs.piano.refresh(e[1],e[3])},pianoPanelAction(e){console.log("here2",e),this.$refs.pianoPanel.callFunc(e)},pianoRollAction(e){this.$refs.testCanvas.callFunc(e)},timbrePanelAction(e){this.$refs.timbrePanel.callFunc(e)},timbreSpaceAction(e){this.$refs.timbrePalette.callFunc(e)},changeTrk(e){let t={func:"selectChangeTrk",arg:e};this.pianoRollAction(t),this.timbreSpaceAction(t),this.$refs.pianoPanel.$refs.audioPanel.setSelectTrk(e),this.$refs.pianoPanel.selectTrk=e,this.$refs.timbrePanel.selectTrk=e,this.selectTrk=e},updateSources(e){if(null!=e)return this.sources=e,void console.log(this.sources);let t=this.$refs.timbrePalette.timbreDB.centerData.tag,a=[];for(let s=0;s<t.length;++s)a.push({value:s+1+"",label:t[s]});this.sources=a,this.changeTrk(this.selectTrk)}}};const sa=(0,$.Z)(aa,[["render",g]]);var ia=sa,la={name:"App",components:{DoodlePanel:ia}};const na=(0,$.Z)(la,[["render",l]]);var ra=na,oa=e=>{e.use(Et.ZP)};const da=(0,s.ri)(ra);oa(da),da.mount("#app")}},t={};function a(s){var i=t[s];if(void 0!==i)return i.exports;var l=t[s]={id:s,loaded:!1,exports:{}};return e[s].call(l.exports,l,l.exports,a),l.loaded=!0,l.exports}a.m=e,function(){var e=[];a.O=function(t,s,i,l){if(!s){var n=1/0;for(h=0;h<e.length;h++){s=e[h][0],i=e[h][1],l=e[h][2];for(var r=!0,o=0;o<s.length;o++)(!1&l||n>=l)&&Object.keys(a.O).every((function(e){return a.O[e](s[o])}))?s.splice(o--,1):(r=!1,l<n&&(n=l));if(r){e.splice(h--,1);var d=i();void 0!==d&&(t=d)}}return t}l=l||0;for(var h=e.length;h>0&&e[h-1][2]>l;h--)e[h]=e[h-1];e[h]=[s,i,l]}}(),function(){a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,{a:t}),t}}(),function(){a.d=function(e,t){for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}}(),function(){a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){a.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={143:0};a.O.j=function(t){return 0===e[t]};var t=function(t,s){var i,l,n=s[0],r=s[1],o=s[2],d=0;if(n.some((function(t){return 0!==e[t]}))){for(i in r)a.o(r,i)&&(a.m[i]=r[i]);if(o)var h=o(a)}for(t&&t(s);d<n.length;d++)l=n[d],a.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return a.O(h)},s=self["webpackChunksantouguai_demo_v03"]=self["webpackChunksantouguai_demo_v03"]||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))}();var s=a.O(void 0,[998],(function(){return a(2018)}));s=a.O(s)})();
//# sourceMappingURL=app.6a1b247b.js.map